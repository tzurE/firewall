#include "exploits.h"


int check_for_php_attack(char* http_command){

	// This whole feature is BROKEN and should not be used.
	// Shutting it down.
	if ((strstr(http_command, "php") != NULL) && (strstr(http_command, "cmd=") != NULL)){
		printk("found a PHPFILEMNGR attack! dropping packets!\n");
		return -12;
	}

	return 1;
}


int check_coppermine_attack(char* http_command){
	char* point;
	char* point2;
	char* point3;
	char ch;
	int i;

	// the 3 unsanitized vars
	point = strstr(http_command, "angle=");
	point2 = strstr(http_command, "quality=");
	point3 = strstr(http_command, "clipval=");

	// check for problematic chars:
	// the application does not sanitize the variables, so I do it here.
	if (point != NULL){
		i = 6;
		ch = point[6];
		while (ch != '&'){
			if ((ch > '9' ) || (ch < '0')){
				printk("Found Coppermine attack in var angle! dropping\n");
				return -14;
			}
			i++;
			ch = point[i];
		}
	}

	if (point2 != NULL){
		i = 8;
		ch = point2[8];
		while (ch != '&'){
			if ((ch > '9' ) || (ch < '0')){
				printk("Found Coppermine attack in var quality! dropping\n");
				return -14;
			}
			i++;
			ch = point[i];
		}
	}

	if (point3 != NULL){
		i = 8;
		ch = point3[8];
		while (ch != '&'){
			// clipval can actually get a ','
			if (((ch > '9' ) || (ch < '0')) && ch != ','){
				printk("Found Coppermine attack in var clipval! dropping\n");
				return -14;
			}
			i++;
			ch = point[i];
		}
	}

	// Check if using local image with POST
	// This is another way to use the attack, so we use another check - just in case.
	// This SHOULD DEFENITLY catch an attack if all else failed.
	if (strstr(http_command, "../images/") != NULL){
		return -14;
	}
	return 1;
}